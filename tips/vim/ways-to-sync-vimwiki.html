<!DOCTYPE html>
<html>
<head>
<title>你要怎么同步你的 vimwiki ?  - 丘迟的维基世界</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="Stylesheet" type="text/css" href="../../style.css" />
<script> var kwiki_identifier = 'wiki_../../_你要怎么同步你的 vimwiki ?  - 丘迟的维基世界', root_path = '../../'; </script>
</head>
<body>
<div id="all">
<div id="header">
	<ul id="top-nav">
		<li>
			<a href="../../index.html">首页</a>
		</li>
		<li>
			<a href="../../tips/index.html">经验总结</a>
		</li>
		<li>
			<a href="../../diary/diary.html">日记</a>
		</li>
	</ul>
</div>
<div id="cse"></div>
<div id="main">
<p>
<h1>同步 vimwiki 到线上的各种方法</h1>
<div class="toc">
<ul>
<li><a href="#toc_0.1">Windows下的解决方案</a></li>
<ul>
<li><a href="#toc_0.1.1">使用 Git + Batch file/VBS</a></li>
<li><a href="#toc_0.1.2">使用 Github Pages</a></li>
<li><a href="#toc_0.1.3">使用自己的服务器</a></li>
</ul>
<li><a href="#toc_0.2">Linux下的解决方案</a></li>
</ul>
</ul>
</div>
由于 vimwiki 需要手动生成静态 HTML ，如果你想发布 ，就需要把这些HTML都传到线上去。传文件很麻烦啊，有没有省事儿点的办法呢。抽点时间来写同步脚本吧，长痛不如短痛。
</p>

<p>
首先分析一下这个同步需求：
</p>
<ol>
<li>
需要自动同步 vimwiki_html 的所有文件
</li>
<li>
有变更的文件才同步上去
</li>
<li>
被删掉的文件也要能同步删掉
</li>
<li>
由于文件修改频繁，不需要一旦修改就马上同步
</li>
<li>
有需要时可以手动同步
</li>
<li>
最好能排除一些不用放在线上的文件
</li>
<li>
不能占用太多系统资源
</li>
</ol>

<h2 id="toc_0.1">Windows下的解决方案</h2>

<p>
看了上面的需求分析，相信大家想到的都是各自版本管理工具。那就来试试时下最火的 git 吧！
</p>

<h3 id="toc_0.1.1">使用 Git + Batch file/VBS</h3>
<p>
要使用 git ，可以选择自建 git server ，或者使用 github 的 public repository 。
</p>

<p>
先说用 github 的情况。首先<a href="http://github.com/repositories/new">新建一个仓库</a>，我这里使用的项目名是 <strong>kwiki</strong> 。获得SSH地址 <code>git@github.com:ktmud/kwiki.git</code> 。
</p>

<p>
接着把 vimwiki_html 文件夹初始化为 git 项目， <code>push</code> 到 github 上去。
</p>

<p>
接下来就要想办法让本地目录定时自动 <code>push</code> 到 github ， Web服务器上的www目录也要定时从 github 上 <code>checkout</code> 。既然要使用公开的git仓库，就绕不开用户验证。在Windows下的最好的解决方案是使用 <strong>msysgit</strong> ，相信会用 Git 的人都已经按照<a href="http://help.github.com/msysgit-key-setup/">Github上的指导</a>建立了 ssh key 。但不知道你试过 ssh-agent 这个东西没有？简单来说，它可以让你不用每次提交修改到 git
服务器时都输入密码。请参照这篇教程进行设置：<a href="http://help.github.com/working-with-key-passphrases/">http://help.github.com/working-with-key-passphrases/</a> 。
</p>

<p>
然后可以写一段批处理脚本，自动完成 commit, push 等操作。但经过本人亲身尝试，虽然 msysgit 可以让 Window 命令行里有 git 命令可以用，却不能在里面享用 ssh-agent 的登录状态，要做到免密码输入，*只能进入到 git bash ，然后用 vbs 模拟键盘输入*。这段 vbs 我是暂时没有能力写出来了。而且就算能写，还牵涉到判断提交是否已经成功的问题，就算我们爱折腾，也要量力而行哈。
</p>

<p>
所以，一劳永逸的方法还是生成ssh key时不要设置 passphrase 。鉴于这个 key 并不那么容易被泄露，不要 passphrase 是可以接受的。赶快去更新一下你的 ssh key 吧！
</p>

<p>
只要可以无人值守地 <code>git push</code> ，就可以使用下面的批处理脚本：
</p>
<pre>
@echo off
title 通过 Git 同步.. 
::Start...
echo Start synchronizing...

echo Commit changes...

:: get date and time 
for /f "delims=" %%a in ('date/t') do @set mydate=%%a 
for /f "delims=" %%a in ('time/t') do @set mytime=%%a 
set fvar=%mydate%%mytime% 

:: add all new files 
call git add . 
call git commit -a -m "Automated commit on %fvar%"

:: push to the server. Default in "origin" remote, "master" branch
call git push
</pre>

<p>
另存为 sync.bat ，放到 vimwiki_html 目录下。然后将其添加到 Windows 的任务计划程序里，就可以做到定时推送。或者你不喜欢定时推送，每次有需要时再运行这个脚本也可以。来，绑定一个运行此脚本的快捷键。
</p>

<p>
鉴于<a href="http://wiki.ktmud.com/tips/vim/vimwiki-guide.html#toc_0.3.3">我们之前定义的生成HTML快捷键是&lt;F4&gt;</a>，那就定义 &lt;C-F4&gt; 为提交好了：
</p>
<blockquote>
map &lt;C-F4&gt; :exec '!cmd.exe /k "cd "'.VimwikiGet('path_html').'" &amp; sync"'&lt;cr&gt;
</blockquote>

<p>
如果你愿意，还可以把生成与提交一起都做了：
</p>
<blockquote>
map &lt;C-F4&gt; &lt;S-F4&gt;:silent exec '!cmd.exe /k "cd "'.VimwikiGet('path_html').'" &amp; sync"'&lt;cr&gt;
</blockquote>


<p>
但现在只是做到了自动推送，网页的显示怎么办呢？
</p>

<p>
有两种解决方案，使用 github 的 pages ，或者在一个有 shell 权限的服务器上拉取一个 git 仓库副本，然后建立 cronjob 。
</p>

<h3 id="toc_0.1.2">使用 Github Pages</h3>
<p>
请参考：
</p>
<ol>
<li>
<a href="http://pages.github.com/">Github Pages 帮助文档</a>
</li>
</ol>

<p>
很爽的是，github 不仅提供 pages ，还提供 CNAME 功能，可以用你自己的域名访问 github pages 。 我们的目的是把 wiki 放在 wiki.yourname.com 的根目录下，而不是以仓库名命名的子目录。于是，不可避免地，需要新建一个帐号才行。看起来，新帐号似乎需要新的 ssh key 才能提交更改，其实是不必的。我们不用这个新帐号做 git push 就可以了。使用新帐号登录，在“管理员”页面（右上角搜索框的下面有链接）把你的主帐号添加为协作者，这样本地就能继续使用主帐号的ssh key登录，在做 push 也不会提示权限不足了。
</p>

<p>
然后回到 vimwiki_html ， <code>git remote add kwiki git@...</code> &amp;&amp; <code>git push kwiki gh-pages</code> 。简单吧？
</p>

<p>
OK，现在耐心等待 github 为你生成 pages 。因为添加了一个 remote ，刚才那个 sync.bat 也要改一下了。把最后一句改为：
</p>
<pre>
call git push origin master
call git push origin gh-pages
call git push kwiki gh-pages
call git push kwiki master
</pre>
<p>
很变态吧？枚举什么的最讨厌了。据说其实有镜像功能，这个还得再研究。
</p>

<p>
接着，按照 <a href="http://pages.github.com/">Github Pages 帮助文档</a> 的说明，添加 CNAME ，一切搞定！
</p>

<p>
等待， github 页面生成后，会给用户发送提醒邮件。每次同步成功都有这个邮件，多烦人啊，到 <a href="https://github.com/account/notifications">https://github.com/account/notifications</a> 去改一下设置吧！
</p>
 

<h3 id="toc_0.1.3">使用自己的服务器</h3>
<p>
有两种方案，一，把web服务器作为git客户端，从github上拉文件，这个太戳了，还需要建立 cronjob ，待会儿再说；二，把web服务器作为可以建立公共访问的 git 服务器（其实就是另一个 github ），由本地主动推送过去。
</p>

<ol>
<li>
请先阅读<a href="http://progit.org/book/zh/ch4-4.html">Pro Git 上有关架设服务器的文档</a>。
</li>
<li>
然后就可以<a href="http://progit.org/book/zh/ch4-5.html">这样来搞</a>。也可以读一读这篇：<a href="http://toroid.org/ams/git-website-howto">Using Git to manage a web site</a> ，讲的是一回事情。
</li>
</ol>

<p>
在第一篇文章中，重点是把你的 SSH 公钥添加到服务器的 authorized_keys 里。可以参考明城的《[ <a href="http://www.gracecode.com/archives/3030/">http://www.gracecode.com/archives/3030/</a> 我是如此得深爱着 SSH》(额.. 麻~) 这篇文章。至于要不要限制 git 推送用户的 shell 权限，就看你个人选择了。
</p>

<p>
比 github pages 简单。
</p>

<p>
弄好之后，别忘了在 sync.bat 里添加 push 到你自己服务器的语句。
</p>

<p>
哇塞，这样子一搞，我们的维基一下子就有三个镜像了！
</p>
    

<h2 id="toc_0.2">Linux下的解决方案</h2>
<p>
没有了 git bash 的重重限制，写起脚本来应该简单得多。至少不用纠结用 bat 还是 vbs 的问题。这个问题咱以后再议。（因为现在我也搞不懂～ =.= ... ）
</p>
</div>
<div id="footer">
    <p>&copy; 2010 丘迟 &nbsp;&nbsp; <a href="../../SiteMap.html" title="站点地图">给我一点导航吧</a></p>
</div>
</div>
<script src="../../jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="../../vimwiki.js" type="text/javascript"></script>
</body>
</html>
